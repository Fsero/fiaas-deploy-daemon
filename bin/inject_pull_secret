#!/usr/bin/env bash

B64CMD="$(command -v gbase64)"
if [[ -z "${B64CMD}" ]]; then
    B64CMD="$(command -v base64)"
fi

set -euo pipefail

DOCKERCONFIGJSON="$(jq '{"auths": {"https://containers.schibsted.io/": .auths."containers.schibsted.io"}}'   < ~/.docker/config.json | ${B64CMD} -w 0)"

for namespace in $(kubectl --context minikube get namespaces -o jsonpath='{.items[*].metadata.name}'); do

    kubectl --context minikube --namespace "$namespace" apply -f - <<EOF
kind: Secret
apiVersion: v1
metadata:
  name: containers.schibsted.io
data:
  .dockerconfigjson: ${DOCKERCONFIGJSON}
type: kubernetes.io/dockerconfigjson
EOF
    kubectl --context minikube --namespace "$namespace" patch serviceaccount default -p '{"imagePullSecrets":[{"name":"containers.schibsted.io"}]}'
done
